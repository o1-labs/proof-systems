#!/bin/sh
# Test preimage read from VM request to server response
# Usage: test_preimage_read.sh [OP_DB_DIR] [NETWORK_NAME]

source rpcs.sh 

set +u
if [ -z "${FILENAME}" ]; then
    FILENAME="$(./generate-config.sh)"
fi
set -u

source $FILENAME


set -x

# Location of prepopulated OP DB
# OP_PROGRAM_DATA_DIR is generated by ./generate-config.sh 
# It makes sense to use it as default value here
DATADIR=${1:-${OP_PROGRAM_DATA_DIR}}
NETWORK=${2:-sepolia}

# If you actually need to populate the OP DB, run
#################################################
# ${OP_DIR}/op-program/bin/op-program \         #
#     --log.level DEBUG \                       #
#     --l1 ${L1RPC} \                           #
#     --l2 ${L2RPC} \                           #
#     --network ${NETWORK} \                    #
#     --datadir ${DATADIR} \                    #
#     --l1.head ${L1_HEAD} \                    #
#     --l2.head ${L2_HEAD} \                    #
#     --l2.outputroot ${STARTING_OUTPUT_ROOT} \ #
#     --l2.claim ${L2_CLAIM} \                  #
#     --l2.blocknumber ${L2_BLOCK_NUMBER}       #
#################################################



RUST_LOG=debug cargo run -r --bin kimchi_optimism -- --preimage-db-dir ${DATADIR}  -- \
    ${OP_DIR}/op-program/bin/op-program \
    --log.level DEBUG \
    --l1 ${L1RPC} \
    --l2 ${L2RPC} \
    --network ${NETWORK} \
    --datadir ${DATADIR} \
    --l1.head ${L1_HEAD} \
    --l2.head ${L2_HEAD} \
    --l2.outputroot ${STARTING_OUTPUT_ROOT} \
    --l2.claim ${L2_CLAIM} \
    --l2.blocknumber ${L2_BLOCK_NUMBER} \
    --server
