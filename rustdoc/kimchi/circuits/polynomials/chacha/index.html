<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="This module implements the cha-cha constraints, which are rather simple aside form the lookups. There are four chacha constraint types, corresponding to the four lines in each quarter round."><meta name="keywords" content="rust, rustlang, rust-lang, chacha"><title>kimchi::circuits::polynomials::chacha - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../../../../normalize.css"><link rel="stylesheet" type="text/css" href="../../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../../../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../../../../dark.css" disabled><link rel="stylesheet" type="text/css" href="../../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../../storage.js"></script><script src="../../../../crates.js"></script><script defer src="../../../../main.js"></script>
    <noscript><link rel="stylesheet" href="../../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../../kimchi/index.html"><div class="logo-container"><img class="rust-logo" src="../../../../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"></h2>
    </nav>
    <nav class="sidebar"><a class="sidebar-logo" href="../../../../kimchi/index.html"><div class="logo-container"><img class="rust-logo" src="../../../../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"><a href="#">Module chacha</a></h2><div class="sidebar-elems"><section><div class="block"><ul><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#functions">Functions</a></li></ul></div></section><div id="sidebar-vars" data-name="chacha" data-ty="mod" data-relpath="./"></div><script defer src="./sidebar-items.js"></script></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../../../kimchi/index.html"><img class="rust-logo" src="../../../../rust-logo.svg" alt="logo"></a><nav class="sub"><div class="theme-picker hidden"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="22" height="22" alt="Pick another theme!" src="../../../../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><div class="main-heading">
    <h1 class="fqn"><span class="in-band">Module <a href="../../../index.html">kimchi</a>::<wbr><a href="../../index.html">circuits</a>::<wbr><a href="../index.html">polynomials</a>::<wbr><a class="mod" href="#">chacha</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../../../../src/kimchi/circuits/polynomials/chacha.rs.html#1-644">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>This module implements the cha-cha constraints, which are rather simple aside form the lookups.
There are four chacha constraint types, corresponding to the four lines in each quarter round.</p>
<pre>
a += b; d ^= a; d <<<= 16;
c += d; b ^= c; b <<<= 12;
a += b; d ^= a; d <<<= 8;
c += d; b ^= c; b <<<= 7;
</pre>
<p>or, written without mutation, (and where + is mod 2**32),</p>
<pre>
a'  = a + b ; d' = (d ^ a') <<< 16;
c'  = c + d'; b' = (b ^ c') <<< 12;
a'' = a' + b'; d'' = (d' ^ a') <<< 8;
c'' = c' + d''; b'' = (c'' ^ b') <<< 7;
</pre>
<p>We lay each line as two rows.</p>
<p>Each line has the form</p>
<pre>
x += z; y ^= x; y <<<= k
</pre>
<p>or without mutation,</p>
<pre>
x' = x + z; y' = (y ^ x') <<< k
</pre>
<p>which we abbreviate as</p>
<pre>
L(x, x', y, y', z, k).
</pre>
<p>In general, such a line will be laid out as the two rows</p>
<pre>
x  y  z       (y^x')_0 (y^x')_1 (y^x')_2 (y^x')_3 (x+z)_0 (x+z)_1 (x+z)_2 (x+z)_3 y_0 y_1 y_2 y_3
x' y' (x+z)_8 (y^x')_4 (y^x')_5 (y^x')_6 (y^x')_7 (x+z)_4 (x+z)_5 (x+z)_6 (x+z)_7 y_4 y_5 y_6 y_7
</pre>
<p>where A_i indicates the i^th nybble (four-bit chunk) of the value A.</p>
<p>(x+z)_8 is special, since we know it is actually at most 1 bit (representing the overflow bit of x + z).</p>
<p>So the first line L(a, a’, d, d’, b, 8) for example becomes the two rows</p>
<pre>
a  d  b       (d^a')_0 (d^a')_1 (d^a')_2 (d^a')_3 (a+b)_0 (a+b)_1 (a+b)_2 (a+b)_3 d_0 d_1 d_2 d_3
a' d' (a+b)_8 (d^a')_4 (d^a')_5 (d^a')_6 (d^a')_7 (a+b)_4 (a+b)_5 (a+b)_6 (a+b)_7 d_4 d_5 d_6 d_7
</pre>
<p>along with the equations</p>
<pre>
(a+b)_8^2 = (a+b)_8  [booleanity check]
a' = sum_{i = 0}^7 (2^4)^i (a+b)_i;
a + b = 2^32 (a+b)_8 + a';
d = sum_{i = 0}^7 (2^4)^i d_i
d' = sum_{i = 0}^7 (2^4)^{(i + 4) mod 8} (a+b)_i
</pre>
<p>The (i + 4) mod 8 rotates the nybbles left by 4, which means bit-rotating by 4*4 = 16
as desired.</p>
<p>The final line is a bit more complicated as we have to rotate by 7, which is not a multiple of 4.
We accomplish this as follows.</p>
<p>Let’s say we want to rotate the nybbles A_0, …, A_7 left by 7.
First we’ll rotate left by 4 to get</p>
<p>A_7, A_0, A_1, …, A_6</p>
<p>Rename these as</p>
<p>B_0, …, B_7.</p>
<p>We now want to left-rotate each B_i by 3.</p>
<p>Let b_i be the low bit of B_i.
Then, the low 3 bits of B_i are
(B_i - b_i) / 2.</p>
<p>The result will thus be</p>
<p>2^3 b_0 + (B_7 - b_7)/2,
2^3 b_1 + (B_0 - b_0)/2,
2^3 b_2 + (B_1 - b_1)/2,
…
2^3 b_7 + (B_6 - b_6)/2,</p>
<p>or re-writing in terms of our original nybbles A_i,</p>
<p>2^3 a_7 + (A_6 - a_6)/2,
2^3 a_0 + (A_7 - a_7)/2,
2^3 a_1 + (A_0 - a_0)/2,
2^3 a_2 + (A_1 - a_1)/2,
2^3 a_3 + (A_2 - a_2)/2,
2^3 a_4 + (A_3 - a_3)/2,
2^3 a_5 + (A_4 - a_4)/2,
2^3 a_6 + (A_5 - a_5)/2,</p>
<p>For neatness, letting (x, y, z) = (c’, b’, d’’), the first 2 rows for the final
line will be,</p>
<pre>
x  y  z       (y^x')_0 (y^x')_1 (y^x')_2 (y^x')_3 (x+z)_0 (x+z)_1 (x+z)_2 (x+z)_3 y_0 y_1 y_2 y_3
x' _  (x+z)_8 (y^x')_4 (y^x')_5 (y^x')_6 (y^x')_7 (x+z)_4 (x+z)_5 (x+z)_6 (x+z)_7 y_4 y_5 y_6 y_7
</pre>
<p>but then we also need to perform the bit-rotate by 1.</p>
<p>For this we’ll add an additional 2 rows. It’s probably possible to do it with just 1,
but I think we’d have to change our plookup setup somehow, or maybe expand the number of columns,
or allow access to the previous row.</p>
<p>Let lo(n) be the low bit of the nybble n. The 2 rows will be</p>
<p>y’ (y^x’)_0 (y^x’)_1 (y^x’)_2 (y^x’)_3 lo((y^x’)_0) lo((y^x’)_1) lo((y^x’)_2) lo((y^x’)_3)
_  (y^x’)_4 (y^x’)_5 (y^x’)_6 (y^x’)_7 lo((y^x’)_4) lo((y^x’)_5) lo((y^x’)_6) lo((y^x’)_7)</p>
<p>On each of them we’ll do the plookups</p>

<div class='information'><div class='tooltip ignore'>ⓘ</div></div><div class="example-wrap"><pre class="rust rust-example-rendered ignore"><code>((<span class="ident">cols</span>[<span class="number">1</span>] <span class="op">-</span> <span class="ident">cols</span>[<span class="number">5</span>])<span class="op">/</span><span class="number">2</span>, (<span class="ident">cols</span>[<span class="number">1</span>] <span class="op">-</span> <span class="ident">cols</span>[<span class="number">5</span>])<span class="op">/</span><span class="number">2</span>, <span class="number">0</span>) <span class="kw">in</span> <span class="ident">XOR</span>
((<span class="ident">cols</span>[<span class="number">2</span>] <span class="op">-</span> <span class="ident">cols</span>[<span class="number">6</span>])<span class="op">/</span><span class="number">2</span>, (<span class="ident">cols</span>[<span class="number">2</span>] <span class="op">-</span> <span class="ident">cols</span>[<span class="number">6</span>])<span class="op">/</span><span class="number">2</span>, <span class="number">0</span>) <span class="kw">in</span> <span class="ident">XOR</span>
((<span class="ident">cols</span>[<span class="number">3</span>] <span class="op">-</span> <span class="ident">cols</span>[<span class="number">7</span>])<span class="op">/</span><span class="number">2</span>, (<span class="ident">cols</span>[<span class="number">3</span>] <span class="op">-</span> <span class="ident">cols</span>[<span class="number">7</span>])<span class="op">/</span><span class="number">2</span>, <span class="number">0</span>) <span class="kw">in</span> <span class="ident">XOR</span>
((<span class="ident">cols</span>[<span class="number">4</span>] <span class="op">-</span> <span class="ident">cols</span>[<span class="number">8</span>])<span class="op">/</span><span class="number">2</span>, (<span class="ident">cols</span>[<span class="number">4</span>] <span class="op">-</span> <span class="ident">cols</span>[<span class="number">8</span>])<span class="op">/</span><span class="number">2</span>, <span class="number">0</span>) <span class="kw">in</span> <span class="ident">XOR</span></code></pre></div>
<p>which checks that ((y^x’)_i - lo((y^x’)_i)) is a nybble,
which guarantees that the low bit is computed correctly.</p>
<p>There is no need to check nybbleness of (y^x’)_i because those will be constrained to
be equal to the copies of those values from previous rows, which have already been
constrained for nybbleness (by the lookup in the XOR table).</p>
<p>And we’ll check that y’ is the sum of the shifted nybbles.</p>
</div></details><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="mod" href="testing/index.html" title="kimchi::circuits::polynomials::chacha::testing mod">testing</a></div><div class="item-right docblock-short"></div></div></div><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ChaCha0.html" title="kimchi::circuits::polynomials::chacha::ChaCha0 struct">ChaCha0</a></div><div class="item-right docblock-short"><p>Implementation of the ChaCha0 gate</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ChaCha1.html" title="kimchi::circuits::polynomials::chacha::ChaCha1 struct">ChaCha1</a></div><div class="item-right docblock-short"><p>Implementation of the ChaCha1 gate</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ChaCha2.html" title="kimchi::circuits::polynomials::chacha::ChaCha2 struct">ChaCha2</a></div><div class="item-right docblock-short"><p>Implementation of the ChaCha2 gate</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ChaChaFinal.html" title="kimchi::circuits::polynomials::chacha::ChaChaFinal struct">ChaChaFinal</a></div><div class="item-right docblock-short"><p>Implementation of the ChaChaFinal gate</p>
</div></div></div><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="fn" href="fn.xor_table.html" title="kimchi::circuits::polynomials::chacha::xor_table fn">xor_table</a></div><div class="item-right docblock-short"><p>The lookup table for 4-bit xor.
Note that it is constructed so that (0, 0, 0) is the last position in the table.</p>
</div></div></div></section><section id="search" class="content hidden"></section></div></main><div id="rustdoc-vars" data-root-path="../../../../" data-current-crate="kimchi" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.61.0-nightly (58f11791a 2022-03-17)" ></div>
</body></html>