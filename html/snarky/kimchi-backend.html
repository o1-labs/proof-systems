<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Kimchi backend - Mina book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././assets/css/mdbook-admonish.css">
        <link rel="stylesheet" href="../././mdbook-admonish.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Foundations</li><li class="chapter-item expanded "><a href="../fundamentals/zkbook_foundations.html"><strong aria-hidden="true">2.</strong> Terminology</a></li><li class="chapter-item expanded "><a href="../fundamentals/zkbook_groups.html"><strong aria-hidden="true">3.</strong> Groups</a></li><li class="chapter-item expanded "><a href="../fundamentals/zkbook_rings.html"><strong aria-hidden="true">4.</strong> Rings</a></li><li class="chapter-item expanded "><a href="../fundamentals/zkbook.html"><strong aria-hidden="true">5.</strong> Fields</a></li><li class="chapter-item expanded "><a href="../fundamentals/zkbook_polynomials.html"><strong aria-hidden="true">6.</strong> Polynomials</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../fundamentals/zkbook_multiplying_polynomials.html"><strong aria-hidden="true">6.1.</strong> Multiplying polynomials</a></li><li class="chapter-item expanded "><a href="../fundamentals/zkbook_fft.html"><strong aria-hidden="true">6.2.</strong> Fast Fourier transform</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Cryptographic tools</li><li class="chapter-item expanded "><a href="../fundamentals/zkbook_commitment.html"><strong aria-hidden="true">7.</strong> Commitments</a></li><li class="chapter-item expanded "><a href="../plonk/polynomial_commitments.html"><strong aria-hidden="true">8.</strong> Polynomial commitments</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../plonk/inner_product.html"><strong aria-hidden="true">8.1.</strong> Inner product argument</a></li><li class="chapter-item expanded "><a href="../plonk/inner_product_api.html"><strong aria-hidden="true">8.2.</strong> Different functionnalities</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Proof systems</li><li class="chapter-item expanded "><a href="../fundamentals/proof_systems.html"><strong aria-hidden="true">9.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../fundamentals/zkbook_plonk.html"><strong aria-hidden="true">10.</strong> zk-SNARKs</a></li><li class="chapter-item expanded "><a href="../fundamentals/custom_constraints.html"><strong aria-hidden="true">11.</strong> Custom constraints</a></li><li class="chapter-item expanded affix "><li class="part-title">Background on PLONK</li><li class="chapter-item expanded "><a href="../plonk/overview.html"><strong aria-hidden="true">12.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../plonk/glossary.html"><strong aria-hidden="true">13.</strong> Glossary</a></li><li class="chapter-item expanded "><a href="../plonk/domain.html"><strong aria-hidden="true">14.</strong> Domain</a></li><li class="chapter-item expanded "><a href="../plonk/lagrange.html"><strong aria-hidden="true">15.</strong> Lagrange basis in multiplicative subgroups</a></li><li class="chapter-item expanded "><a href="../plonk/fiat_shamir.html"><strong aria-hidden="true">16.</strong> Non-interaction with fiat-shamir</a></li><li class="chapter-item expanded "><a href="../plonk/plookup.html"><strong aria-hidden="true">17.</strong> Plookup</a></li><li class="chapter-item expanded "><a href="../plonk/maller.html"><strong aria-hidden="true">18.</strong> Maller's optimization</a></li><li class="chapter-item expanded affix "><li class="part-title">Kimchi</li><li class="chapter-item expanded "><a href="../kimchi/overview.html"><strong aria-hidden="true">19.</strong> Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../kimchi/arguments.html"><strong aria-hidden="true">19.1.</strong> Arguments</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../kimchi/gates.html"><strong aria-hidden="true">19.1.1.</strong> Custom gates</a></li><li class="chapter-item expanded "><a href="../kimchi/permut.html"><strong aria-hidden="true">19.1.2.</strong> Permutation</a></li><li class="chapter-item expanded "><a href="../kimchi/lookup.html"><strong aria-hidden="true">19.1.3.</strong> Lookup</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">Snarky</li><li class="chapter-item expanded "><a href="../snarky/overview.html"><strong aria-hidden="true">20.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../snarky/api.html"><strong aria-hidden="true">21.</strong> API</a></li><li class="chapter-item expanded "><a href="../snarky/snarky-wrapper.html"><strong aria-hidden="true">22.</strong> snarky wrapper</a></li><li class="chapter-item expanded "><a href="../snarky/kimchi-backend.html" class="active"><strong aria-hidden="true">23.</strong> Kimchi backend</a></li><li class="chapter-item expanded "><a href="../snarky/vars.html"><strong aria-hidden="true">24.</strong> Vars</a></li><li class="chapter-item expanded "><a href="../snarky/booleans.html"><strong aria-hidden="true">25.</strong> Booleans</a></li><li class="chapter-item expanded "><a href="../snarky/circuit-generation.html"><strong aria-hidden="true">26.</strong> Circuit generation</a></li><li class="chapter-item expanded "><a href="../snarky/witness-generation.html"><strong aria-hidden="true">27.</strong> Witness generation</a></li><li class="chapter-item expanded affix "><li class="part-title">Pickles & Inductive Proof Systems</li><li class="chapter-item expanded "><a href="../fundamentals/zkbook_ips.html"><strong aria-hidden="true">28.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../pickles/accumulation.html"><strong aria-hidden="true">29.</strong> Accumulation</a></li><li class="chapter-item expanded "><a href="../pickles/deferred.html"><strong aria-hidden="true">30.</strong> Deferred Computation</a></li><li class="chapter-item expanded "><a href="../pickles/passthrough.html"><strong aria-hidden="true">31.</strong> Passthough & Me-Only</a></li><li class="chapter-item expanded affix "><li class="part-title">RFCs</li><li class="chapter-item expanded "><a href="../plonk/zkpm.html"><strong aria-hidden="true">32.</strong> RFC 0: Alternative zero-knowledge</a></li><li class="chapter-item expanded "><a href="../plonk/final_check.html"><strong aria-hidden="true">33.</strong> RFC 1: Final check</a></li><li class="chapter-item expanded "><a href="../plonk/maller_15.html"><strong aria-hidden="true">34.</strong> RFC 2: Maller's optimization for kimchi</a></li><li class="chapter-item expanded "><a href="../rfcs/3-lookup.html"><strong aria-hidden="true">35.</strong> RFC 3: Plookup integration in kimchi</a></li><li class="chapter-item expanded "><a href="../rfcs/ffadd.html"><strong aria-hidden="true">36.</strong> RFC 4: Foreign Field Addition</a></li><li class="chapter-item expanded "><a href="../rfcs/keccak.html"><strong aria-hidden="true">37.</strong> RFC 5: Keccak</a></li><li class="chapter-item expanded affix "><li class="part-title">Specifications</li><li class="chapter-item expanded "><a href="../specs/poseidon.html"><strong aria-hidden="true">38.</strong> Poseidon hash</a></li><li class="chapter-item expanded "><a href="../specs/poly-commitment.html"><strong aria-hidden="true">39.</strong> Polynomial commitment</a></li><li class="chapter-item expanded "><a href="../specs/pasta.html"><strong aria-hidden="true">40.</strong> Pasta curves</a></li><li class="chapter-item expanded "><a href="../specs/kimchi.html"><strong aria-hidden="true">41.</strong> Kimchi</a></li><li class="chapter-item expanded "><a href="../specs/urs.html"><strong aria-hidden="true">42.</strong> Universal Reference String (URS)</a></li><li class="chapter-item expanded "><a href="../specs/pickles.html"><strong aria-hidden="true">43.</strong> Pickles</a></li><li class="chapter-item expanded "><a href="../specs/consensus.html"><strong aria-hidden="true">44.</strong> Consensus</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Mina book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://www.github.com/o1-labs/proof-systems" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="kimchi-backend"><a class="header" href="#kimchi-backend">Kimchi Backend</a></h1>
<p><img src="https://i.imgur.com/KmKU5Pl.jpg" alt="" /></p>
<p>Underneath the snarky wrapper (in <code>snarky/checked_runner.rs</code>) lies what we used to call the <code>plonk_constraint_system</code> or <code>kimchi_backend</code> in <code>snarky/constraint_systen.rs</code>.</p>
<div id="admonition-note" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="#admonition-note"></a></p>
</div>
<div>
<p>It is good to note that we’re planning on removing this abstract separation between the snarky wrapper and the constraint system.</p>
</div>
</div>
<p>The logic in the kimchi backend serves two purposes:</p>
<ul>
<li><strong>Circuit generation</strong>. It is the logic that adds gates to our list of gates (representing the circuit). For most of these gates, the variables used are passed to the backend by the snarky wrapper, but some of them are created by the backend itself (see more in the <a href="#variables">variables section</a>).</li>
<li><strong>Witness generation</strong>. It is the logic that creates the witness</li>
</ul>
<p>One can also perform two additional operations once the constraint system has been compiled:</p>
<ul>
<li>Generate the prover and verifier index for the system.</li>
<li>Get a hash of the constraint system (this includes the circuit, the number of public input) (TODO: verify that this is true) (TODO: what else should be in that hash? a version of snarky and a version of kimchi?).</li>
</ul>
<h2 id="a-circuit"><a class="header" href="#a-circuit">A circuit</a></h2>
<p>A circuit is either being built, or has been contructed during a circuit generation phase:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>enum Circuit&lt;F&gt;
where
    F: PrimeField,
{
    /** A circuit still being written. */
    Unfinalized(Vec&lt;GateSpec&lt;(), F&gt;&gt;),
    /** Once finalized, a circuit is represented as a digest
        and a list of gates that corresponds to the circuit.
    */
    Compiled([u8; 32], Vec&lt;CircuitGate&lt;F&gt;&gt;),
}
<span class="boring">}</span></code></pre></pre>
<h2 id="state"><a class="header" href="#state">State</a></h2>
<p>The state of the kimchi backend looks like this:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>where
    Field: PrimeField,
{
    /// A counter used to track variables
    /// (similar to the one in the snarky wrapper)
    next_internal_var: usize,

    /// Instruction on how to compute each internal variable 
    /// (as a linear combination of other variables).
    /// Used during witness generation.
    internal_vars: HashMap&lt;InternalVar, (Vec&lt;(Field, V)&gt;, Option&lt;Field&gt;)&gt;,

    /// The symbolic execution trace table.
    /// Each cell is a variable that takes a value during witness generation.
    /// (if not set, it will take the value 0).
    rows: Vec&lt;Vec&lt;Option&lt;V&gt;&gt;&gt;,

    /// The circuit once compiled
    gates: Circuit&lt;Field&gt;,

    /// The row to use the next time we add a constraint.
    // TODO: I think we can delete this
    next_row: usize,

    /// The size of the public input
    /// (which fills the first rows of our constraint system.
    public_input_size: Option&lt;usize&gt;,

    // omitted values...
}
<span class="boring">}</span></code></pre></pre>
<h2 id="variables"><a class="header" href="#variables">Variables</a></h2>
<p>In the backend, there’s two types of variables:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>enum V {
    /// An external variable 
    /// (generated by snarky, via [exists]).
    External(usize),

    /// An internal variable is generated to hold an intermediate value,
    /// (e.g. in reducing linear combinations to single PLONK positions).
    Internal(InternalVar),
}
<span class="boring">}</span></code></pre></pre>
<p>Internal variables are basically a <code>usize</code> pointing to a hashmap in the state.</p>
<p>That hashmap tells you how to compute the internal variable during witness generation: it is always a linear combination of other variables (and a constant).</p>
<h2 id="circuit-generation"><a class="header" href="#circuit-generation">Circuit generation</a></h2>
<p>During circuit generation, the snarky wrapper will make calls to the <code>add_constraint()</code> or <code>add_basic_snarky_constraint</code> function of the kimchi backend, specifying what gate to use and what variables to use in that gate.</p>
<p>At this point, the snarky wrapper might have some variables that are not yet tracked as such (with a counter).
Rather, they are constants, or they are a combination of other variables.
You can see that as a small AST representing how to compute a variable.
(See the <a href="./vars.html#circuit-vars">variables section</a> for more details).</p>
<p>For this reason, they can hide a number of operations that haven’t been constrained yet.
It is the role of the <code>add_constrain</code> logic to enforce that at this point constants, as well as linear combinations or scalings of variables, are encoded in the circuit. 
This is done by adding enough generic gates (using the <code>reduce_lincom()</code> or <code>reduce_to_var()</code> functions).</p>
<div id="admonition-note-1" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="#admonition-note-1"></a></p>
</div>
<div>
<p>This is a remnant of an optimization targetting R1CS (in which additions are for free).
An issue with this approach is the following: imagine that two circuit variables are created from the same circuit variable, imagine also that the original circuit variable contained a long AST, then both variables might end up creating the same constraints to convert that AST.
Currently, snarkyjs and pickles expose a <code>seal()</code> function that allows you to reduce this issue, at the cost of some manual work and mental tracking on the developer.
We should probably get rid of this, while making sure that we can continue to optimize generic gates 
(in some cases you can merge two generic gates in one (TODO: give an example of where that can happen)).
Another solution is to keep track of what was reduced, and reuse previous reductions (similar to how we handle constants).</p>
</div>
</div>
<p>It is during this “reducing” step that internal variables (known only to the kimchi backend) are created.</p>
<div id="admonition-note-2" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="#admonition-note-2"></a></p>
</div>
<div>
<p>The process is quite safe, as the kimchi backend cannot use the snarky wrapper variables directly (which are of type <code>CVar</code>).
Since the expected format (see the <a href="#variables">variables section</a> is a number (of type <code>usize</code>), the only way to convert a non-tracked variable (constant, or scale, or linear combination) is to reduce it (and in the process constraining its value).</p>
</div>
</div>
<p>Depending on the gate being used, several constraints might be added via the <code>add_row()</code> function which does three things:</p>
<ol>
<li>figure out if there’s any wiring to be done</li>
<li>add a gate to our list of gates (representing the circuit)</li>
<li>add the variables to our <em>symbolic</em> execution trace table (symbolic in the sense that nothing has values yet)</li>
</ol>
<p>This process happens as the circuit is “parsed” and the constraint functions of the kimchi backend are called.</p>
<p>This does not lead to a finalized circuit, see the next section to see how that is done.</p>
<p>(TODO: ideally this should happen in the same step)</p>
<h2 id="finalization-of-the-circuit"><a class="header" href="#finalization-of-the-circuit">Finalization of the circuit.</a></h2>
<p>So far we’ve only talked about adding specific constraints to the circuit, but not about how public input are handled.</p>
<p>The <code>finalization()</code> function of the kimchi backend does the following:</p>
<ul>
<li>add as many generic rows as there are public inputs.</li>
<li>construct the permutation </li>
<li>computes a cache of the circuit (TODO: this is so unecessary)</li>
<li>and other things that are not that important</li>
</ul>
<h2 id="witness-generation"><a class="header" href="#witness-generation">Witness generation</a></h2>
<p>Witness generation happens by taking the finalized state (in the <code>compute_witness()</code> function) with a callback that can be used to retrieve the values of external variables (public input and public output).</p>
<p>The algorithm follows these steps using the symbolic execution table we built during circuit generation:</p>
<ol>
<li>it initializes the execution trace table with zeros</li>
<li>go through the rows related to the public input and set the most-left column values to the ones obtained by the callback.</li>
<li>go through the other rows and compute the value of the variables left in the table</li>
</ol>
<p>Variables in step 3. should either:</p>
<ul>
<li>be absent (<code>None</code>) and evaluated to the default value 0</li>
<li>point to an external variable, in which case the closure passed can be used to retrieve the value</li>
<li>be an internal variable, in which case the value is computed by evaluating the AST that was used to create it.</li>
</ul>
<h2 id="permutation"><a class="header" href="#permutation">Permutation</a></h2>
<p>The permutation is used to wire cells of the execution trace table (specifically, cells belonging to the first 7 columns).
It is also known as “copy constraints”.</p>
<div id="admonition-note-3" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="#admonition-note-3"></a></p>
</div>
<div>
<p>In snarky, the permutation is represented differently from kimchi, and thus needs to be converted to the kimchi’s format before a proof can be created.
TODO: merge the representations</p>
</div>
</div>
<p>We use the permutation in ingenious ways to optimize circuits. 
For example, we use it to encode each constants once, and wire it to places where it is used. 
Another example, is that we use it to assert equality between two cells.</p>
<h2 id="implementation-details"><a class="header" href="#implementation-details">Implementation details</a></h2>
<p>There’s two aspect of the implementation of the permutation, the first one is a hashmap of equivalence classes, which is used to track all the positions of a variable, the second one is making use of a <a href="">union find</a> data structure to link variables that are equivalent (we’ll talk about that after).</p>
<p>The two data structures are in the kimchi backend’s state:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct SnarkyConstraintSystem&lt;Field&gt;
where
    Field: PrimeField,
{
    equivalence_classes: HashMap&lt;V, Vec&lt;Position&lt;Row&gt;&gt;&gt;,
    union_finds: disjoint_set::DisjointSet&lt;V&gt;,
    // omitted fields...
}
<span class="boring">}</span></code></pre></pre>
<h3 id="equivalence-classes"><a class="header" href="#equivalence-classes">equivalence classes</a></h3>
<p>As said previously, during circuit generation a symbolic execution trace table is created. It should look a bit like this (if there were only 3 columns and 4 rows):</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center"></th><th style="text-align: center">0</th><th style="text-align: center">1</th><th style="text-align: center">2</th></tr></thead><tbody>
<tr><td style="text-align: center">0</td><td style="text-align: center">v1</td><td style="text-align: center">v1</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">1</td><td style="text-align: center"></td><td style="text-align: center">v2</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">2</td><td style="text-align: center"></td><td style="text-align: center">v2</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">3</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center">v1</td></tr>
</tbody></table>
</div>
<p>From that, it should be clear that all the cells containing the variable <code>v1</code> should be connected, 
and all the cells containing the variable <code>v2</code> should be as well.</p>
<p>The format that the permutation expects is a <a href="https://en.wikipedia.org/wiki/Cyclic_permutation">cycle</a>: a list of cells where each cell is linked to the next, the last one wrapping around and linking to the first one.</p>
<p>For example, a cycle for the <code>v1</code> variable could be:</p>
<pre><code>(0, 0) -&gt; (0, 1)
(0, 1) -&gt; (3, 2)
(3, 2) -&gt; (0, 0)
</code></pre>
<p>During circuit generation, a hashmap (called <code>equivalence_classes</code>) is used to track all the positions (row and column) of each variable.</p>
<p>During finalization, all the different cycles are created by looking at all the variables existing in the hashmap.</p>
<h3 id="union-finds"><a class="header" href="#union-finds">Union finds</a></h3>
<p>Sometimes, we know that two variables will have equivalent values due to an <code>assert_equal()</code> being called to link them.
Since we link two variables together, they need to be part of the same cycle, and as such we need to be able to detect that to construct correct cycles.</p>
<p>To do this, we use a <a href="">union find</a> data structure, which allows us to easily find the unions of equivalent variables.</p>
<p>When an <code>assert_equal()</code> is called, we link the two variables together using the <code>union_finds</code> data structure.</p>
<p>During finalization, when we create the cycles, we use the <code>union_finds</code> data structure to find the equivalent variables.
We then create a new equivalence classes hashmap to merge the keys (variables) that are in the same set.
This is done before using the equivalence classes hashmap to construct the cycles.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../snarky/snarky-wrapper.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../snarky/vars.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../snarky/snarky-wrapper.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../snarky/vars.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </body>
</html>
